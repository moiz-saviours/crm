function getActiveFormId(){let e=document.querySelector(".tab-pane.fade.show.active");return e?e.querySelector("form").id:null}function getFieldId(e){let t=getActiveFormId();return t?`${e}-${t.split("-")[1]}`:null}function detectCardType(e){for(let[t,n]of Object.entries({visa:/^4/,mastercard:/^5[1-5]|^22[2-9][0-9]|^2[3-6][0-9]{2}|^27[01][0-9]|^2720/,amex:/^3[47]/,discover:/^6(?:011|5|4[4-9])/,diners:/^3(?:0[0-5]|[68])/,jcb:/^(?:2131|1800|35)/}))if(n.test(e))return t;return null}function validateForm(){if(!getActiveFormId())return!1;let e=[];return"stripe"!==getActiveFormId().split("-")[1]&&e.push({id:getFieldId("card_number"),isValid:validateCardNumber()},{id:getFieldId("cvv"),isValid:validateCVV()},{id:getFieldId("expiry_month"),isValid:validateExpiryMonth()},{id:getFieldId("expiry_year"),isValid:validateExpiryYear()}),e.push({id:getFieldId("first_name"),isValid:validateFirstName()},{id:getFieldId("last_name"),isValid:validateLastName()},{id:getFieldId("email"),isValid:validateEmail()},{id:getFieldId("phone"),isValid:validatePhone()},{id:getFieldId("country"),isValid:validateCountry()},{id:getFieldId("address"),isValid:validateAddress()},{id:getFieldId("city"),isValid:validateCity()},{id:getFieldId("zipcode"),isValid:validateZipcode()},{id:getFieldId("state"),isValid:validateState()}),e.find((e=>!e.isValid))?.id?document.getElementById(e.find((e=>!e.isValid)).id):null}function validateCardNumber(){let e=getFieldId("card_number"),t=document.getElementById(e).value.replace(/-/g,""),n=document.getElementById(`${e}_error`);return/^\d{13,19}$/.test(t)?luhnCheck(t)?(n.textContent="",!0):(n.textContent="Invalid card number. Please check again.",!1):(n.textContent="Invalid card number. Must be 13 to 19 digits.",!1)}function validateCVV(){let e=getFieldId("cvv"),t=document.getElementById(e),n=document.getElementById(`${e}_error`);return/^\d{3,4}$/.test(t.value)?(n.textContent="",!0):(n.textContent="Invalid CVV. Must be 3 or 4 digits.",!1)}function validateExpiryMonth(){let e=getFieldId("expiry_month"),t=document.getElementById(e).value,n=getFieldId("expiry_year"),a=document.getElementById(n).value,r=document.getElementById(`${e}_error`),i=document.getElementById(`${e}_error`);if(!t)return r.textContent="Please select a valid expiry month.",!1;if(a){let e=(new Date).getFullYear(),n=(new Date).getMonth()+1;if(parseInt(a)<e||parseInt(a)===e&&parseInt(t)<n)return i.textContent="Card has expired.",!1;i.textContent=""}return r.textContent="",!0}function validateExpiryYear(){let e=getFieldId("expiry_year"),t=document.getElementById(e).value,n=getFieldId("expiry_month"),a=document.getElementById(n).value,r=document.getElementById(`${e}_error`),i=document.getElementById(`${e}_error`);if(!t)return r.textContent="Please select a valid expiry year.",!1;if(a){let e=(new Date).getFullYear(),n=(new Date).getMonth()+1;if(parseInt(t)<e||parseInt(t)===e&&parseInt(a)<n)return i.textContent="Card has expired.",!1;i.textContent=""}return r.textContent="",!0}function validateFirstName(){let e=getFieldId("first_name"),t=document.getElementById(e).value,n=document.getElementById(`${e}_error`);return t.trim()?/\d/.test(t)?(n.textContent="First name should not contain numbers.",!1):/[^a-zA-Z ]/.test(t)?(n.textContent="First name should not contain special characters.",!1):(n.textContent="",!0):(n.textContent="First name is required.",!1)}function validateLastName(){let e=getFieldId("last_name"),t=document.getElementById(e).value,n=document.getElementById(`${e}_error`);return t.trim()?/\d/.test(t)?(n.textContent="Last name should not contain numbers.",!1):/[^a-zA-Z ]/.test(t)?(n.textContent="Last name should not contain special characters.",!1):(n.textContent="",!0):(n.textContent="Last name is required.",!1)}function validateEmail(){let e=getFieldId("email"),t=document.getElementById(e).value,n=document.getElementById(`${e}_error`);return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)?/^\S+@\S+\.\S+$/.test(t)?(n.textContent="",!0):(n.textContent="Invalid email format.",!1):(n.textContent="Invalid email address.",!1)}function validatePhone(){let e=getFieldId("phone"),t=document.getElementById(e).value,n=document.getElementById(`${e}_error`);if(/[a-zA-Z]/.test(t))return n.textContent="Phone number should not contain alphabets or invalid characters.",!1;let a=t.replace(/\D/g,"");return/^\d{10,15}$/.test(a)?(n.textContent="",!0):(n.textContent="Invalid phone number. Must be 10 to 15 digits.",!1)}function validateCountry(){let e=getFieldId("country"),t=document.getElementById(e).value,n=document.getElementById(`${e}_error`);return t?(n.textContent="",!0):(n.textContent="Please select a country.",!1)}function validateAddress(){let e=getFieldId("address"),t=document.getElementById(e).value,n=document.getElementById(`${e}_error`);return t.trim()?(n.textContent="",!0):(n.textContent="Address is required.",!1)}function validateCity(){let e=getFieldId("city"),t=document.getElementById(e).value,n=document.getElementById(`${e}_error`);return t.trim()?(n.textContent="",!0):(n.textContent="City is required.",!1)}function validateZipcode(){let e=getFieldId("zipcode"),t=document.getElementById(e).value,n=getFieldId("country"),a=document.getElementById(n).value,r=document.getElementById(`${e}_error`),i=!1,d="";switch(a){case"US":i=/^\d{5}(-\d{4})?$/.test(t),d="Invalid US zip code. Must be 5 digits (e.g., 12345) or 9 digits (e.g., 12345-6789).";break;case"CA":i=/^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$/.test(t),d="Invalid Canadian postal code. Must be in the format A1A 1A1.";break;case"UK":i=/^[A-Za-z]{1,2}\d{1,2}[A-Za-z]? \d[A-Za-z]{2}$/.test(t),d="Invalid UK postal code. Must be in the format A1 1AA, A11 1AA, AA1 1AA, or AA11 1AA.";break;case"IN":i=/^\d{6}$/.test(t),d="Invalid Indian postal code. Must be 6 digits.";break;case"AU":i=/^\d{4}$/.test(t),d="Invalid Australian postal code. Must be 4 digits.";break;default:i=/^[A-Za-z0-9\s\-]{3,10}$/.test(t),d="Invalid postal code."}return i?(r.textContent="",!0):(r.textContent=d,!1)}function validateState(){let e=getFieldId("state"),t=document.getElementById(e).value,n=document.getElementById(`${e}_error`);return t.trim()?(n.textContent="",!0):(n.textContent="State is required.",!1)}function luhnCheck(e){let t=0;for(let n=0;n<e.length;n++){let a=parseInt(e[e.length-1-n]);n%2==1&&(a*=2)>9&&(a-=9),t+=a}return t%10==0}document.addEventListener("input",(function(e){if(e.target.id.includes("card_number")){let t=getFieldId("card_type_logo"),n=document.getElementById(t),a=e.target.value.replace(/\D/g,"");e.target.value=a.replace(/(\d{4})(?=\d)/g,"$1-");let r=detectCardType(a);r?(n.className=`cctype ${r}`,n.style.display="block"):n.style.display="none"}})),document.addEventListener("DOMContentLoaded",(function(){document.addEventListener("change",(function(e){if(e.target.matches('input[type="checkbox"][name="shipping"]')){let t=e.target,n=t.closest("form").querySelector(".shipping-fields");n&&(n.style.display=t.checked?"none":"block")}}));let e=getFieldId("country");function t(e){let t=e.target,n=t.name,a=getFieldId(n),r=document.getElementById(`${a}_error`);if(!r)return;let i=t.value.trim(),d="";if(""!==i){if(n.includes("card_number")){let e=i.replace(/-/g,"");/^\d{13,19}$/.test(e)?luhnCheck(e)||(d="Invalid card number. Please check again."):d="Enter a valid 13-19 digit card number."}else if(n.includes("cvv"))/^\d{3,4}$/.test(i)||(d="CVV must be 3-4 digits.");else if(n.includes("first_name")||n.includes("last_name"))/[^a-zA-Z ]/.test(i)?d="Only letters and spaces allowed.":/\s/.test(i)&&!/[a-zA-Z]/.test(i)&&(d="Please enter a valid name.");else if(n.includes("email"))/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)||(d="Enter a valid email address.");else if(n.includes("phone")){let e=i.replace(/\D/g,"");/^\d{10,15}$/.test(e)||(d="Invalid phone number. Must be 10 to 15 digits.")}else{if(n.includes("expiry_month"))return validateExpiryMonth(),void validateExpiryYear();if(n.includes("expiry_year"))return validateExpiryYear(),void validateExpiryMonth();n.includes("zipcode")||n.includes("country")||n.includes("address")||n.includes("city")||n.includes("state")}r.textContent=d}else r.textContent=""}function n(e){let t=e.target,n=document.getElementById(`${t.id}_error`);n&&(n.textContent="")}document.getElementById(e).addEventListener("change",validateZipcode),document.querySelectorAll(".paymentForm").forEach((e=>{e.querySelectorAll("input, select").forEach((e=>{e.addEventListener("blur",t),e.addEventListener("focus",n)}))}));let a=document.getElementById(getFieldId("expiry_month")),r=document.getElementById(getFieldId("expiry_year"));a&&a.addEventListener("change",(function(){validateExpiryMonth(),r&&r.value&&validateExpiryYear()})),r&&r.addEventListener("change",(function(){validateExpiryYear(),a&&a.value&&validateExpiryMonth()}))})),$(document).ready((function(){let e=["Counting coins...","Bribing the bank manager...","Convincing the payment gateway...","Training the payment pigeons...","Negotiating with the money tree...","Polishing the credit card...","Asking the ATM nicely...","Charging the payment lasers...","Summoning the payment wizard...","Calming the angry payment gods..."],t=0,n=null,a=document.querySelector(".loader-container"),r=document.querySelector(".funny-message");function i(){r.textContent=e[t],t=(t+1)%e.length}function d(){a.style.display="none",n&&clearInterval(n)}d(),$(".paymentForm").on("submit",(async function(e){e.preventDefault();let t=$(this).find('button[type="submit"]'),r=t.text();t.prop("disabled",!0).text("Processing...");let l=validateForm();if(l){let u=$(`#${l.id}_error`).text()||"Please correct the errors in the form.";return toastr.error(u,"Validation Error"),l.scrollIntoView({behavior:"smooth",block:"center"}),void t.prop("disabled",!1).text(r)}a.style.display="flex",n=setInterval(i,500);let o=$(this).serializeArray();o=o.map((e=>("card_number"===e.name&&(e.value=e.value.replace(/\D/g,"")),e)));let s=e.target.action;if(s.includes("stripe")){try{const m=await window.stripe.createPaymentMethod({type:"card",card:cardElement,billing_details:{name:`${$(this).find('input[name="first_name"]').val()} ${$(this).find('input[name="last_name"]').val()}`,email:$(this).find('input[name="email"]').val(),address:{line1:$(this).find('input[name="address"]').val(),city:$(this).find('input[name="city"]').val(),state:$(this).find('input[name="state"]').val(),postal_code:$(this).find('input[name="zipcode"]').val(),country:$(this).find('select[name="country"]').val()}}});if(m.error)return void c(m.error);o.push({name:"payment_method",value:m.paymentMethod.id})}catch(g){console.log(g),c(g)}function c(e){let t=(e.type||"error").replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()));toastr.error(e.message||"An unexpected error occurred. Please try again.",t),document.getElementById("card-stripe").scrollIntoView({behavior:"smooth",block:"center"}),$("#card-stripe_error").text(e.message||"An error occurred"),setTimeout((()=>{$("#card-stripe_error").text("")}),3e3),d(),t.prop("disabled",!1).text(r)}}$.ajax({url:s,type:"POST",data:o,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},dataType:"json",success:function(e){e.message&&toastr.success(e.message,"Success"),location.reload()},error:function(e,n,a){let i=e.responseJSON,l=i?.error||a||"Something went wrong. Please try again.";if(422===e.status||i.errors){let e=!1;$.each(i.errors,(function(t,n){e=!0,document.getElementById(getFieldId(t)).scrollIntoView({behavior:"smooth",block:"center"}),$(`#${getFieldId(t)}_error`).text(n)})),toastr.error(i.message,"Error")}else toastr.error(l,"Error");s.includes("stripe")&&(document.getElementById("card-stripe").scrollIntoView({behavior:"smooth",block:"center"}),$("#card-stripe_error").text(l)),console.log(a),d(),t.prop("disabled",!1).text(r)},complete:function(){t.prop("disabled",!1).text(r)}})}))}));
